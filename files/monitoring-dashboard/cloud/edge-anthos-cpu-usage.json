{
  "category": "CUSTOM",
  "displayName": "Edge - Anthos CPU Usage",
  "labels": {
    "retail-edge": "true",
    "{{ cluster_name }}": "true"
  },
  "mosaicLayout": {
    "columns": 12,
    "tiles": [
      {
        "height": 4,
        "widget": {
          "title": "Host CPU Usage %",
          "xyChart": {
            "chartOptions": {
              "mode": "COLOR"
            },
            "dataSets": [
              {
                "plotType": "LINE",
                "targetAxis": "Y1",
                "timeSeriesQuery": {
                  "timeSeriesQueryLanguage": "fetch gce_instance\n| metric 'agent.googleapis.com/cpu/utilization'\n| filter (metric.cpu_state == 'idle')\n| group_by 1m,\n    [value_utilization_mean: cast_units(100, '%') - mean(value.utilization)]\n| every 1m\n| group_by\n    [metric.cpu_number, resource.instance_id, resource.zone,\n     metadata.user.category: metadata.user_labels.category,\n     metadata.user.location: metadata.user_labels.location,\n     metadata.user.type: metadata.user_labels.type,\n     metadata.user.vxlanid: metadata.user_labels.vxlanid,\n     metadata.system.name: metadata.system_labels.name,\n     metadata.system.region: metadata.system_labels.region,\n     metadata.system.state: metadata.system_labels.state],\n    [value_utilization_mean_aggregate: aggregate(value_utilization_mean)]"
                }
              }
            ],
            "thresholds": [
              {
                "label": "",
                "targetAxis": "Y1",
                "value": 85
              }
            ],
            "timeshiftDuration": "0s",
            "yAxis": {
              "label": "y1Axis",
              "scale": "LINEAR"
            }
          }
        },
        "width": 6,
        "xPos": 0,
        "yPos": 0
      },
      {
        "height": 4,
        "widget": {
          "title": "K8s Node CPU Allocation %",
          "xyChart": {
            "chartOptions": {
              "mode": "COLOR"
            },
            "dataSets": [
              {
                "plotType": "LINE",
                "targetAxis": "Y1",
                "timeSeriesQuery": {
                  "timeSeriesQueryLanguage": "{ t_0:\n    fetch k8s_container\n    | metric\n        'kubernetes.io/anthos/kube_pod_container_resource_requests_cpu_cores'\n    | group_by 1m,\n        [value_kube_pod_container_resource_requests_cpu_cores_mean:\n           mean(value.kube_pod_container_resource_requests_cpu_cores)]\n    | every 1m\n    | group_by [node: metric.node],\n        [value_kube_pod_container_resource_requests_cpu_cores_mean_aggregate:\n           aggregate(value_kube_pod_container_resource_requests_cpu_cores_mean)]\n; t_1:\n    fetch k8s_container\n    | metric 'kubernetes.io/anthos/kube_node_status_allocatable_cpu_cores'\n    | group_by 1m,\n        [value_kube_node_status_allocatable_cpu_cores_mean:\n           mean(value.kube_node_status_allocatable_cpu_cores)]\n    | every 1m\n    | group_by [node: metric.node],\n        [value_kube_node_status_allocatable_cpu_cores_mean_aggregate:\n           aggregate(value_kube_node_status_allocatable_cpu_cores_mean)] }\n| join\n| value\n    [v_0:\n       cast_units(\n         div(\n           t_0.value_kube_pod_container_resource_requests_cpu_cores_mean_aggregate,\n           t_1.value_kube_node_status_allocatable_cpu_cores_mean_aggregate)\n         * 100,\n         '%')]\n| top 10, v_0"
                }
              }
            ],
            "thresholds": [
              {
                "label": "",
                "targetAxis": "Y1",
                "value": 80
              }
            ],
            "timeshiftDuration": "0s",
            "yAxis": {
              "label": "y1Axis",
              "scale": "LINEAR"
            }
          }
        },
        "width": 6,
        "xPos": 6,
        "yPos": 0
      },
      {
        "height": 4,
        "widget": {
          "title": "Top 10 Container CPU Seconds Usage",
          "xyChart": {
            "chartOptions": {
              "mode": "COLOR"
            },
            "dataSets": [
              {
                "plotType": "LINE",
                "targetAxis": "Y1",
                "timeSeriesQuery": {
                  "timeSeriesQueryLanguage": "fetch k8s_container\n| metric 'kubernetes.io/anthos/process_cpu_seconds_total'\n| align rate(1m)\n| every 1m\n| top 10, max(value.process_cpu_seconds_total)"
                }
              }
            ],
            "timeshiftDuration": "0s",
            "yAxis": {
              "label": "y1Axis",
              "scale": "LINEAR"
            }
          }
        },
        "width": 6,
        "xPos": 0,
        "yPos": 4
      },
      {
        "height": 2,
        "widget": {
          "scorecard": {
            "sparkChartView": {
              "sparkChartType": "SPARK_LINE"
            },
            "timeSeriesQuery": {
              "timeSeriesQueryLanguage": "fetch gce_instance\n| metric 'agent.googleapis.com/cpu/utilization'\n| filter (metric.cpu_state == 'idle')\n| group_by 1m, [value_utilization_max: cast_units(100,\"%\")-max(value.utilization)]\n| every 1m\n| group_by [], [value_utilization_max_max: max(value_utilization_max)]"
            }
          },
          "title": "Max CPU Utilization %"
        },
        "width": 4,
        "xPos": 0,
        "yPos": 8
      },
      {
        "height": 4,
        "widget": {
          "title": "Top 10 Container CPU Core Requested",
          "xyChart": {
            "chartOptions": {
              "mode": "COLOR"
            },
            "dataSets": [
              {
                "plotType": "LINE",
                "targetAxis": "Y1",
                "timeSeriesQuery": {
                  "timeSeriesQueryLanguage": "fetch k8s_container\n| metric 'kubernetes.io/anthos/kube_pod_container_resource_requests_cpu_cores'\n| group_by 1m,\n    [value_kube_pod_container_resource_requests_cpu_cores_mean:\n       mean(value.kube_pod_container_resource_requests_cpu_cores)]\n| every 1m\n| top 10\n| group_by\n    [metric.container, metric.namespace, metric.node, metric.pod,\n     resource.location, resource.cluster_name, resource.namespace_name,\n     resource.pod_name, resource.container_name],\n    [value_kube_pod_container_resource_requests_cpu_cores_mean_aggregate:\n       aggregate(value_kube_pod_container_resource_requests_cpu_cores_mean)]"
                }
              }
            ],
            "timeshiftDuration": "0s",
            "yAxis": {
              "label": "y1Axis",
              "scale": "LINEAR"
            }
          }
        },
        "width": 6,
        "xPos": 6,
        "yPos": 4
      }
    ]
  }
}
