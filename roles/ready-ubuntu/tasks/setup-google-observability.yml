- name: Get service facts
  service_facts:
  tags:
  - observability-agent-install
  - observability-setup

  ### Configure Monitoring agent
- name: Copy collectd config
  template:
    src: collectd.conf.j2
    dest: "/etc/stackdriver/collectd.conf"
    owner: root
    group: root
    mode: '0644'
  tags:
  - monitoring-agent-config
  - observability-setup

- name: Copy stackdriver initd script
  template:
    src: stackdriver-agent.j2
    dest: "/etc/init.d/stackdriver-agent"
    owner: root
    group: root
    mode: '0755'
  tags:
  - monitoring-agent-config
  - observability-setup

### Configure Logging agent
- name: Copy fluent.d config
  template:
    src: google-fluentd.conf.j2
    dest: "/etc/google-fluentd/google-fluentd.conf"
    owner: root
    group: root
    mode: '0644'
  tags:
  - fluentd-config
  - logging-agent-config
  - observability-setup

- name: Copy fluent initd script
  template:
    src: google-fluentd.j2
    dest: "/etc/init.d/google-fluentd"
    owner: root
    group: root
    mode: '0755'
  tags:
  - fluentd-config
  - logging-agent-config
  - observability-setup

# - name: Copy Syslog config from default install
#   ansible.builtin.copy:
#     src: /etc/google-fluentd/config.d/syslog.conf.dpkg-new
#     dest: /etc/google-fluentd/config.d/syslog.conf
#     owner: root
#     group: root
#     mode: '0600'
#   tags:
#   - fluentd-initd
#   - logging-agent-config
#   - observability-setup

- name: Download Agent scripts
  ansible.builtin.get_url:
    url: "https://dl.google.com/cloudagents/{{ item.script }}"
    dest: "/tmp/{{ item.script }}"
    mode: '0744'
  when: (ansible_facts.services[item.service + '.service'] is undefined) or
        (ansible_facts.services[item.service + '.service'].status != "enabled")
  with_items:
    - { service: 'stackdriver-agent', script: 'add-monitoring-agent-repo.sh' }
    - { service: 'google-fluent', script: 'add-logging-agent-repo.sh' }
  tags:
  - observability-agent-install
  - observability-setup

- name: Run Agent install scripts
  command:
    cmd: "bash /tmp/{{ item.script }} --also-install"
  when: (ansible_facts.services[item.service + '.service'] is undefined) or
        (ansible_facts.services[item.service + '.service'].status != "enabled")
  with_items:
    - { service: 'stackdriver-agent', script: 'add-monitoring-agent-repo.sh' }
    - { service: 'google-fluent', script: 'add-logging-agent-repo.sh' }
  tags:
  - observability-agent-install
  - observability-setup

### Restart both agents after config changes
- name: Restart stackdriver-agent service
  ansible.builtin.service:
    name: "{{ item.service }}"
    enabled: yes
    state: restarted
  with_items:
    - { service: 'stackdriver-agent', script: 'add-monitoring-agent-repo.sh' }
    - { service: 'google-fluent', script: 'add-logging-agent-repo.sh' }
  tags:
  - observability-agent-install
  - ops-agent
  - observability-setup


##############################
##############################
- name: Uninstall packages
  apt:
    name: google-fluentd
    state: absent
  tags:
  - observability-removal

- name: Remove agents
  command:
    cmd: "bash /tmp/{{ item.script }} --uninstall"
  with_items:
    - { service: 'stackdriver-agent', script: 'add-monitoring-agent-repo.sh' }
    - { service: 'google-fluent', script: 'add-logging-agent-repo.sh' }
  tags:
  - observability-removal

- name: Remove all of the config files
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - '/etc/init.d/google-fluentd'
    - '/etc/init.d/stackdriver-agent'
    - '/etc/stackdriver/collectd.conf'
    - '/etc/init.d/google-fluentd'
  tags:
  - observability-removal

